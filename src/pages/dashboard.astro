---
import DashboardLayout from "../layouts/DashboardLayout.astro";
import { app, db } from "../firebase/server";
import { getAuth } from "firebase-admin/auth";
import QRCode from "qrcode";
import AdminDashboard from "../components/AdminDashboard.astro";
import ApplicantDashboard from "../components/ApplicantDashboard.astro";

import getRoleFlags from "../scripts/getRoles.ts";
import type { RoleFlags } from "../scripts/getRoles.ts";
import { FORMS_COLLECTION } from "../utils/utils";

// information that will be displayed in dashboard page
let userUID;
let userEmail: string = "";
let userName: string = "";
let userPhoto;
let registered = false;
let appStatus = "";
let submittedDate = "";


let roles: RoleFlags = {
  isAdmin: false,
  isQrScanner: false,
  isWebDev: false,
  isDirector: false,
};




  
try {
  const auth = getAuth(app);

  // no session or invalid session will redirect to sign in page
  const sessionCookieObj = Astro.cookies.get("__session");
  if (!sessionCookieObj) {
    return Astro.redirect("/");
  }
  const sessionCookie = sessionCookieObj.value;
  const decodedCookie = await auth.verifySessionCookie(sessionCookie);
  if (!decodedCookie) {
    return Astro.redirect("/");
  }

  // invalid user will redirect to sign in page
  const user = await auth.getUser(decodedCookie.uid);
  if (!user) {
    return Astro.redirect("/");
  }

  userUID = user.uid;
  userEmail = user.email as string;
  userName = user.displayName || "";
  userPhoto = user.photoURL;
  roles = getRoleFlags(user);

  // check if the user already register the application:
  const docSnap = await db
    .collection(FORMS_COLLECTION)
    .doc(decodedCookie.email as string)
    .get();
  if (docSnap.exists) {
    registered = true;
    const data = docSnap.data();
    appStatus = data?.appStatus || "";
    submittedDate =
      data?.createdAt
        .toDate()
        .toLocaleString("en-US", { timeZone: "America/Chicago" }) || "";
  }
} catch (err) {
  console.error(err);
  return Astro.redirect("/");
}

const uidDataURI = await QRCode.toDataURL(userEmail, {
  errorCorrectionLevel: "H",
});

const newUserState = (await db.collection("Settings").doc("newUserState").get()).data()?.isNewUserEnabled
---

<DashboardLayout userName={userName} userEmail={userEmail} currentPath={Astro.url.pathname} roles={roles}>
  <div class="main-section">
    {(roles.isAdmin || roles.isWebDev || roles.isDirector) && (
      <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
        <button id="toggle-view-btn" style="padding: 10px 20px; background-color: #BFC3F4; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
          Switch to User View
        </button>
      </div>
    )}
    <div class="main-right-section">
      {
        (roles.isAdmin || roles.isQrScanner || roles.isWebDev || roles.isDirector) ? (
          <>
            <div id="admin-view">
              <AdminDashboard
                roles={roles}
                newUserState={newUserState}
                userName={userName}
                appStatus={appStatus}
              />
            </div>
            {(roles.isAdmin || roles.isWebDev || roles.isDirector) && (
              <div id="user-view" style="display: none;">
                <ApplicantDashboard
                  userName={userName}
                  userEmail={userEmail}
                  appStatus={appStatus}
                  submittedDate={submittedDate}
                  registered={registered}
                  newUserState={newUserState}
                  uidDataURI={uidDataURI}
                />
              </div>
            )}
          </>
        ) : (
          <ApplicantDashboard
            userName={userName}
            userEmail={userEmail}
            appStatus={appStatus}
            submittedDate={submittedDate}
            registered={registered}
            newUserState={newUserState}
            uidDataURI={uidDataURI}
          />
        )
      }
    </div>
  </div>
  <script>
    const toggleNewUsers = document.getElementById(
      "toggle-newusers-btn"
    ) as HTMLButtonElement;

    toggleNewUsers?.addEventListener("click", async () => {
      const currentState = await fetch('/api/auth/toggle-newusers').then(res => res.json());
      const newState = !currentState.isNewUserEnabled;

      try {
        const response = await fetch('/api/auth/toggle-newusers', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ isEnabled: newState }),
        });

        const result = await response.json();
        console.log(result);

        if (result.success) {
          alert(`New Sign ups are now ${newState ? 'enabled' : 'disabled'}`);
          location.reload();
        } else {
          alert('Failed to toggle login state');
        }
      } catch (error) {
        console.error('Error toggling login state:', error);
        alert('An error occurred while toggling the login state');
      }
    });

    // Toggle between admin and user view
    const toggleViewBtn = document.getElementById("toggle-view-btn") as HTMLButtonElement;
    const adminView = document.getElementById("admin-view") as HTMLDivElement;
    const userView = document.getElementById("user-view") as HTMLDivElement;
    let isAdminView = true;

    toggleViewBtn?.addEventListener("click", () => {
      if (isAdminView) {
        // Switch to user view
        adminView.style.display = "none";
        userView.style.display = "block";
        toggleViewBtn.textContent = "Switch to Admin View";
        toggleViewBtn.style.backgroundColor = "#A9D796";
        isAdminView = false;
      } else {
        // Switch to admin view
        adminView.style.display = "block";
        userView.style.display = "none";
        toggleViewBtn.textContent = "Switch to User View";
        toggleViewBtn.style.backgroundColor = "#BFC3F4";
        isAdminView = true;
      }
    });
  </script>
</DashboardLayout>

<style>
  .main-section {
    display: flex;
    flex-direction: column;
    max-width: 100%;
  }

  .main-right-section {
    background-color: #f7f7f7;
    padding: 30px;
    border-radius: 15px;
    width: 100%;
    box-sizing: border-box;
  }
</style>
