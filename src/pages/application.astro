---
import DashboardLayout from "../layouts/DashboardLayout.astro";
import AppForm from "../components/AppForm.tsx";
import { app, db } from "../firebase/server";
import { getAuth } from "firebase-admin/auth";
import type { DocumentData } from "firebase-admin/firestore";
import type { FormViewData } from "../env";
import { FORMS_COLLECTION } from "../utils/utils";

let userName = "";
let userEmail = "";
let registered = false
let applicationData: FormViewData | null = null
let newUserState = true

import getRoleFlags from "../scripts/getRoles.ts";
import type { RoleFlags } from "../scripts/getRoles.ts";
let roles: RoleFlags = {
  isAdmin: false,
  isQrScanner: false,
  isWebDev: false,
  isDirector: false,
};

try {
  const auth = getAuth(app);

  // no session or invalid session will be redirected to sign in page
  const sessionCookieObj = Astro.cookies.get("__session");
  if (!sessionCookieObj) {
    return Astro.redirect("/");
  }
  const sessionCookie = sessionCookieObj.value;
  const decodedCookie = await auth.verifySessionCookie(sessionCookie);
  if (!decodedCookie) {
    return Astro.redirect("/");
  }

  // invalid user will be redirected to sign in page
  const user = await auth.getUser(decodedCookie.uid);
  if (!user) {
    return Astro.redirect("/");
  }
  roles = getRoleFlags(user);

  userName = user.displayName || "";
  userEmail = user.email as string;
  newUserState = (await db.collection("Settings").doc("newUserState").get()).data()?.isNewUserEnabled


  // if already registered then do not render submit button
  const docSnap = await db.collection(FORMS_COLLECTION).doc(decodedCookie.email as string).get()
  if (docSnap.exists) {
    const data = docSnap.data() as DocumentData
    registered = true
    applicationData = {
      email: data.email,
      firstName: data.firstName,
      lastName: data.lastName,
      uin: data.uin,
      gender: data.gender,
      year: data.year,
      availability: data.availability,
      moreAvailability: data.moreAvailability, // optional
      dietaryRestriction: data.dietaryRestriction,
      otherDietaryRestriction: data.otherDietaryRestriction, // optional
      crewneckSize: data.crewneckSize,
      teamPlan: data.teamPlan,
      preWorkshops: data.preWorkshops,
      jobType: data.jobType,
      otherJobType: data.otherJobType, // optional
      resumeLink: data.resumeLink, // optional
      linkedinUrl: data.linkedinUrl, // optional

      // Logistics & Background
      pastSparkHacks: data.pastSparkHacks,
      pastHackathons: data.pastHackathons, // optional
      pastProjects: data.pastProjects,
      participationType: data.participationType,
      hearAbout: data.hearAbout,
      otherHearAbout: data.otherHearAbout, // optional

      // Interest & Goals
      whyInterested: data.whyInterested, // optional
      teamRole: data.teamRole, // optional
      projectInterest: data.projectInterest,
      mainGoals: data.mainGoals,

      // Skills
      skillGit: data.skillGit,
      skillFigma: data.skillFigma,
      skillReact: data.skillReact,
      skillPython: data.skillPython,
      skillDatabase: data.skillDatabase,
      skillCICD: data.skillCICD,
      skillAPIs: data.skillAPIs,

      appStatus: data.appStatus, // status of application
      createdAt: data.createdAt.toDate().toLocaleString("en-US", { timeZone: "America/Chicago"}) || ""
    }
  }

} catch (err) {
  console.error(err);
  return Astro.redirect("/");
}
---

<DashboardLayout userName={userName} userEmail={userEmail} currentPath={Astro.url.pathname} roles={roles}>
  <AppForm email={userEmail} registered={registered} applicationData={applicationData} isAdmin={roles.isAdmin} applicationsClosed={!newUserState} client:only="react" />
</DashboardLayout>
