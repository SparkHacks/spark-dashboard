---
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import { auth } from "../../firebase/server";
import { app } from "../../firebase/server";
import { getAuth } from "firebase-admin/auth";
import RoleManager from "../../components/RoleManager";

import getRoleFlags from "../../scripts/getRoles.ts";
import type { RoleFlags } from "../../scripts/getRoles.ts";
let roles: RoleFlags = {
  isAdmin: false,
  isQrScanner: false,
  isWebDev: false,
  isDirector: false,
};

let allUsers: any[] = [];
let userEmail = "";
let userName = "";
let userPhoto = "";

let isRealDatabase = import.meta.env.REAL_DATABASE === "true" ? "yes" : "no";

try {
  const authInstance = getAuth(app);

  // Get current user info
  const sessionCookieObj = Astro.cookies.get("__session");
  if (!sessionCookieObj) {
    return Astro.redirect("/");
  }
  const sessionCookie = sessionCookieObj.value;
  const decodedCookie = await authInstance.verifySessionCookie(sessionCookie);
  if (!decodedCookie) {
    return Astro.redirect("/");
  }
  const user = await authInstance.getUser(decodedCookie.uid);
  if (!user) {
    return Astro.redirect("/");
  }

  userEmail = user.email as string;
  userName = user.displayName || "";
  userPhoto = user.photoURL || "";

  // Get user roles
  roles = getRoleFlags(user);

  // Check if user has permission to manage admins (admin, webdev, or director)
  if (!roles.isAdmin && !roles.isWebDev && !roles.isDirector) {
    console.error("No permission to manage admins");
    return Astro.redirect("/dashboard");
  }

  const users = await auth.listUsers();
  allUsers = users.users.map(user => ({
    uid: user.uid,
    email: user.email || '',
    displayName: user.displayName || null,
    customClaims: user.customClaims || null
  }));
} catch (err) {
  console.error(err);
}

const getEffectiveRole = () => {
  if (roles.isAdmin) return 'admin';
  if (roles.isDirector) return 'director';
  if (roles.isWebDev) return 'webDev';
  if (roles.isQrScanner) return 'qrScanner';
  return 'none';
};

const effectiveRole = getEffectiveRole();
const canModifyRoles = effectiveRole === 'admin' || effectiveRole === 'director' || effectiveRole === 'webDev'; // WebDev+ can modify roles
const canModifyAdminRole = effectiveRole === 'admin';
---

<DashboardLayout userName={userName} userEmail={userEmail} currentPath={Astro.url.pathname} roles={roles}>
  <div class="admin-section">
    <div class="app-section" style="padding: 30px;">
      <RoleManager
        users={allUsers}
        canModifyRoles={canModifyRoles}
        canModifyAdminRole={canModifyAdminRole}
        client:load
      />
    </div>
  </div>
</DashboardLayout>

<style>
  .admin-section {
    display: flex;
    flex-direction: column;
    max-width: 100%;
  }

  .app-section {
    background-color: #f7f7f7;
    border-radius: 15px;
    width: 100%;
    box-sizing: border-box;
  }
</style>

